// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© ICT x Zodiac Protocol [STRATEGY] - Backtestable Version

//@version=5
strategy("ICT x Zodiac [STRATEGY]", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=2, initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.01)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ STRATEGY SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpStrat = "Strategy Settings"
float riskPercent = input.float(1.0, "Risk %", minval=0.1, maxval=5, step=0.1, group=grpStrat)
float rrRatio = input.float(2.0, "Risk:Reward", minval=1.0, maxval=5.0, step=0.5, group=grpStrat)
bool useZodiacFilter = input.bool(true, "Use Zodiac Alignment Filter", group=grpStrat, tooltip="Only trade when zodiac element aligns with signal direction")
bool onlyStrongZones = input.bool(true, "Only Trade Strong â˜… Zones", group=grpStrat)
bool sbOnly = input.bool(true, "Silver Bullet Window Only", group=grpStrat)

grpSession = "Session Filter"
bool tradeLondon = input.bool(true, "Trade London", group=grpSession)
bool tradeNY = input.bool(true, "Trade NY AM", group=grpSession)
bool tradeSB = input.bool(true, "Trade Silver Bullet", group=grpSession)

grpHTF = "HTF Trend Filter"
bool useHTFFilter = input.bool(true, "Use HTF Trend Filter", group=grpHTF, tooltip="Only trade in direction of higher timeframe trend")
string htfTimeframe = input.string("60", "HTF Timeframe", options=["15", "30", "60", "240", "D"], group=grpHTF)
int htfEmaLen = input.int(50, "HTF EMA Length", minval=10, maxval=200, group=grpHTF)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 1. ZODIAC CALCULATION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
int moonOffset = input.int(10, "Moon Degree Offset", group="Zodiac")

lunarAge() =>
    int y = year
    int m = month
    int d = dayofmonth
    if m <= 2
        y := y - 1
        m := m + 12
    int A = math.floor(y / 100)
    int B = 2 - A + math.floor(A / 4)
    float JD = math.floor(365.25 * (y + 4716)) + math.floor(30.6001 * (m + 1)) + d + B - 1524.5
    float age = (JD - 2451550.1 + moonOffset) % 29.53058867
    if age < 0
        age := age + 29.53058867
    age

float moonAge = lunarAge()
string[] zodiacSigns = array.from("Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces")
int zodiacIdx = math.floor((moonAge / 29.53) * 12) % 12
string currentZodiac = array.get(zodiacSigns, zodiacIdx)

string[] fireSigns = array.from("Aries", "Leo", "Sagittarius")
string[] earthSigns = array.from("Taurus", "Virgo", "Capricorn")
string[] airSigns = array.from("Gemini", "Libra", "Aquarius")
string[] waterSigns = array.from("Cancer", "Scorpio", "Pisces")

bool isFire = array.includes(fireSigns, currentZodiac)
bool isWater = array.includes(waterSigns, currentZodiac)
bool isAir = array.includes(airSigns, currentZodiac)
bool isEarth = array.includes(earthSigns, currentZodiac)

// Zodiac Bias
// FIRE = Expansion (favor longs in uptrend)
// WATER = Manipulation (favor fades/shorts)
// AIR = Consolidation (scalp both)
// EARTH = Structure (deep pullback entries)
bool bullishBias = isFire or isEarth
bool bearishBias = isWater or isAir

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 2. KILLZONE DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool inLondon = not na(time(timeframe.period, "0200-0500", "America/New_York"))
bool inNY = not na(time(timeframe.period, "0700-1000", "America/New_York"))
bool inSB = not na(time(timeframe.period, "1000-1100", "America/New_York"))

bool inTradingSession = (tradeLondon and inLondon) or (tradeNY and inNY) or (tradeSB and inSB)
bool inKillzone = inLondon or inNY or inSB

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 3. FVG DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool isBullFVG = low > high[2]
bool isBearFVG = high < low[2]

// Strength Detection
float avgRange = ta.sma(high - low, 14)
float fvgGapBull = isBullFVG ? (low - high[2]) : 0
float fvgGapBear = isBearFVG ? (low[2] - high) : 0
float dispBody = math.abs(close[1] - open[1])
float avgBody = ta.sma(math.abs(close - open), 14)

bool hasDisplacement = dispBody > avgBody * 1.5
bool strongBullFVG = isBullFVG and fvgGapBull > avgRange * 0.3 and hasDisplacement
bool strongBearFVG = isBearFVG and fvgGapBear > avgRange * 0.3 and hasDisplacement

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 4. HTF TREND FILTER â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float htfEma = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, htfEmaLen), lookahead=barmerge.lookahead_on)
bool htfBullish = close > htfEma
bool htfBearish = close < htfEma

// Plot HTF EMA for reference
plot(useHTFFilter ? htfEma : na, "HTF EMA", color=color.new(color.purple, 50), linewidth=2)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 5. ENTRY CONDITIONS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Silver Bullet signals
float bodySize = math.abs(close - open)
bool disp = bodySize > avgBody * 1.5

bool sbSignalLong = inSB and isBullFVG and disp and close > open
bool sbSignalShort = inSB and isBearFVG and disp and close < open

// Full entry conditions
bool fvgLongBase = sbOnly ? sbSignalLong : (isBullFVG and disp and close > open and inKillzone)
bool fvgShortBase = sbOnly ? sbSignalShort : (isBearFVG and disp and close < open and inKillzone)

// Apply strength filter
bool fvgLongStrength = onlyStrongZones ? strongBullFVG : isBullFVG
bool fvgShortStrength = onlyStrongZones ? strongBearFVG : isBearFVG

// Apply zodiac filter
bool zodiacLongOK = useZodiacFilter ? bullishBias : true
bool zodiacShortOK = useZodiacFilter ? bearishBias : true

// Apply HTF trend filter
bool htfLongOK = useHTFFilter ? htfBullish : true
bool htfShortOK = useHTFFilter ? htfBearish : true

// Final entry signals (all filters must pass)
bool entryLong = fvgLongBase and fvgLongStrength and zodiacLongOK and htfLongOK and inTradingSession
bool entryShort = fvgShortBase and fvgShortStrength and zodiacShortOK and htfShortOK and inTradingSession

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 5. STOP LOSS & TAKE PROFIT â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float atr = ta.atr(14)
float longStop = close - atr * 1.5
float longTP = close + atr * 1.5 * rrRatio
float shortStop = close + atr * 1.5
float shortTP = close - atr * 1.5 * rrRatio

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 6. STRATEGY EXECUTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if entryLong and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=longStop, limit=longTP)

if entryShort and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=shortStop, limit=shortTP)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 7. VISUALS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bgcolor(inSB ? color.new(color.orange, 92) : inNY ? color.new(color.green, 95) : inLondon ? color.new(color.blue, 95) : na)

plotshape(entryLong, style=shape.triangleup, location=location.belowbar, color=color.green, text="ðŸŽ¯", size=size.small)
plotshape(entryShort, style=shape.triangledown, location=location.abovebar, color=color.red, text="ðŸŽ¯", size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 8. DASHBOARD â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var table dash = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 70), border_width=1)

string elemText = isFire ? "ðŸ”¥ FIRE" : isWater ? "ðŸ’§ WATER" : isAir ? "ðŸŒªï¸ AIR" : isEarth ? "ðŸŒ EARTH" : "Neutral"
string biasText = bullishBias ? "BULLISH" : bearishBias ? "BEARISH" : "NEUTRAL"
color biasCol = bullishBias ? color.green : bearishBias ? color.red : color.gray
string htfText = htfBullish ? "â†‘ BULLISH" : "â†“ BEARISH"
color htfCol = htfBullish ? color.green : color.red

if barstate.islast
    table.cell(dash, 0, 0, "ICT x ZODIAC", text_color=color.white, text_size=size.small, bgcolor=color.purple)
    table.merge_cells(dash, 0, 0, 1, 0)
    table.cell(dash, 0, 1, "Element", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 1, elemText, text_color=color.orange, text_size=size.tiny)
    table.cell(dash, 0, 2, "Zodiac Bias", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 2, biasText, text_color=biasCol, text_size=size.tiny)
    table.cell(dash, 0, 3, "HTF Trend", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 3, htfText, text_color=htfCol, text_size=size.tiny)
    table.cell(dash, 0, 4, "Session", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 4, inSB ? "ðŸŽ¯ SILVER BULLET" : inNY ? "NY AM" : inLondon ? "LONDON" : "OFF", text_color=inSB ? color.orange : color.gray, text_size=size.tiny)
    table.cell(dash, 0, 5, "Mode", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 5, onlyStrongZones ? "â˜… STRONG ONLY" : "ALL ZONES", text_color=color.yellow, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ALERTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(entryLong, title="Zodiac LONG Entry", message="ðŸŽ¯ ICT x Zodiac LONG Entry")
alertcondition(entryShort, title="Zodiac SHORT Entry", message="ðŸŽ¯ ICT x Zodiac SHORT Entry")
