// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© AEP Protocol [ICT MODULE]

//@version=5
indicator("AEP x ICT [Silver Bullet]", overlay=true, max_boxes_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ICT SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpICT = "ICT Concepts"
bool showFVG = input.bool(true, "Show Fair Value Gaps", group=grpICT)
bool showSilverBullet = input.bool(true, "Show Silver Bullet Hour (10-11 AM)", group=grpICT)
int maxFVGBoxes = input.int(50, "Max FVG Boxes", minval=10, group=grpICT)
color bullFVGCol = input.color(color.new(color.green, 80), "Bullish FVG", group=grpICT)
color bearFVGCol = input.color(color.new(color.red, 80), "Bearish FVG", group=grpICT)

grpKillzones = "Killzones"
bool showLondonKZ = input.bool(true, "Show London Killzone (2-5 AM)", group=grpKillzones)
bool showNYKZ = input.bool(true, "Show NY Killzone (8:30-11 AM)", group=grpKillzones)

grpDisplacement = "Displacement"
float dispMult = input.float(1.5, "Displacement Body Multiplier", minval=1.0, step=0.1, group=grpDisplacement)
int dispLookback = input.int(10, "Displacement Lookback", minval=5, group=grpDisplacement)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ KILLZONE SESSIONS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool inLondonKZ = not na(time(timeframe.period, "0200-0500", "America/New_York"))
bool inNYKZ = not na(time(timeframe.period, "0830-1100", "America/New_York"))
bool inSilverBullet = not na(time(timeframe.period, "1000-1100", "America/New_York"))

// Background colors for killzones
bgcolor(showLondonKZ and inLondonKZ ? color.new(color.blue, 95) : na, title="London KZ")
bgcolor(showNYKZ and inNYKZ and not inSilverBullet ? color.new(color.purple, 95) : na, title="NY KZ")
bgcolor(showSilverBullet and inSilverBullet ? color.new(color.yellow, 90) : na, title="Silver Bullet")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ FVG DETECTION (THE ENGINE) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Bullish FVG: High of candle[2] is lower than Low of candle[0] (Gap Up)
bool isBullFVG = low > high[2]
float bullTop = low
float bullBot = high[2]

// Bearish FVG: Low of candle[2] is higher than High of candle[0] (Gap Down)
bool isBearFVG = high < low[2]
float bearTop = low[2]
float bearBot = high

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ FVG BOX MANAGEMENT â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var box[] bullFVGBoxes = array.new_box()
var box[] bearFVGBoxes = array.new_box()

// Draw Bullish FVG
if showFVG and isBullFVG
    box newBox = box.new(bar_index[2], bullTop, bar_index + 20, bullBot, border_color=color.new(color.green, 50), bgcolor=bullFVGCol, border_width=1)
    array.push(bullFVGBoxes, newBox)
    if array.size(bullFVGBoxes) > maxFVGBoxes
        box.delete(array.shift(bullFVGBoxes))

// Draw Bearish FVG
if showFVG and isBearFVG
    box newBox = box.new(bar_index[2], bearTop, bar_index + 20, bearBot, border_color=color.new(color.red, 50), bgcolor=bearFVGCol, border_width=1)
    array.push(bearFVGBoxes, newBox)
    if array.size(bearFVGBoxes) > maxFVGBoxes
        box.delete(array.shift(bearFVGBoxes))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ DISPLACEMENT DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float bodySize = math.abs(close - open)
float avgBody = ta.sma(bodySize, dispLookback)
bool displacement = bodySize > avgBody * dispMult

// Bullish displacement = big green candle
bool bullDisplacement = displacement and close > open
// Bearish displacement = big red candle
bool bearDisplacement = displacement and close < open

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SILVER BULLET SIGNALS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Signal fires when:
// 1. Inside Silver Bullet window (10-11 AM NY)
// 2. FVG forms
// 3. Displacement candle created the FVG

bool sbLong = inSilverBullet and isBullFVG and bullDisplacement
bool sbShort = inSilverBullet and isBearFVG and bearDisplacement

// Plot signals
plotshape(sbLong, style=shape.labelup, location=location.belowbar, color=color.green, text="SB\nLONG", textcolor=color.white, size=size.small)
plotshape(sbShort, style=shape.labeldown, location=location.abovebar, color=color.red, text="SB\nSHORT", textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ DASHBOARD â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var table dash = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 70), border_width=1, border_color=color.gray)
if barstate.islast
    table.cell(dash, 0, 0, "ICT MODULE", text_color=color.white, text_size=size.small, bgcolor=color.new(color.orange, 50))
    table.merge_cells(dash, 0, 0, 1, 0)
    
    // Killzone Status
    string kzStatus = inSilverBullet ? "ðŸŽ¯ SILVER BULLET" : inNYKZ ? "ðŸ“ NY KILLZONE" : inLondonKZ ? "ðŸŒ LONDON KZ" : "â¸ï¸ OFF-HOURS"
    color kzCol = inSilverBullet ? color.yellow : inNYKZ ? color.purple : inLondonKZ ? color.blue : color.gray
    table.cell(dash, 0, 1, "Session", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 1, kzStatus, text_color=kzCol, text_size=size.tiny)
    
    // FVG Count
    table.cell(dash, 0, 2, "Bull FVGs", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 2, str.tostring(array.size(bullFVGBoxes)), text_color=color.green, text_size=size.tiny)
    
    table.cell(dash, 0, 3, "Bear FVGs", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 3, str.tostring(array.size(bearFVGBoxes)), text_color=color.red, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ALERTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(sbLong, title="Silver Bullet LONG", message="ICT Silver Bullet LONG signal on {{ticker}}")
alertcondition(sbShort, title="Silver Bullet SHORT", message="ICT Silver Bullet SHORT signal on {{ticker}}")
