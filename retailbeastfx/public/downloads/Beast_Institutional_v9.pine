// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© RetailBeast 2026

//@version=6
indicator("RetailBeastFX Institutional [v9.1]", shorttitle="RBFX v9.1 ğŸ¦", overlay=true, max_bars_back=500, max_lines_count=500, max_boxes_count=500, max_labels_count=500, dynamic_requests=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ INSTITUTIONAL MODE TOGGLE â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string instGroup = "â•â•â• ğŸ¦ INSTITUTIONAL MODE â•â•â•"
bool institutionalMode = input.bool(true, "Institutional Mode", group=instGroup, tooltip="When enabled: ADX>25 gate + SMA bias filter. Disable for Classic Mode fallback.")
int adxPeriod = input.int(14, "ADX Period", minval=7, maxval=21, group=instGroup)
int adxThreshold = input.int(25, "ADX Threshold", minval=15, maxval=40, group=instGroup, tooltip="Minimum ADX for signal activation (25 = trending)")
float atrTrailMult = input.float(3.0, "ATR Trail Multiplier", minval=1.0, maxval=5.0, step=0.5, group=instGroup, tooltip="3x ATR for asymmetric R:R trailing")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ MODE SELECTOR (CLASSIC) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string modeGroup = "â•â•â• MODE SELECTOR â•â•â•"
string modeTooltip = "SCALPER: London/NY killzones only\nDAY TRADER: Extended hours\nSWING: 24/7 with EMA 200 filter"
string gameMode = input.string("SCALPER", "Trading Mode", options=["SCALPER", "DAY TRADER", "SWING"], group=modeGroup, tooltip=modeTooltip)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ KILLZONE SETTINGS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string kzGroup = "â•â•â• KILLZONE SETTINGS â•â•â•"
bool showKillzones = input.bool(true, "Show Killzones", group=kzGroup)
bool killzoneSignalsOnly = input.bool(false, "Signals in Killzones Only", group=kzGroup)

string londonStart = input.session("0300-0600", "London Session", group=kzGroup, inline="london")
color londonColor = input.color(color.new(#00CED1, 85), "", group=kzGroup, inline="london")

string nyStart = input.session("0800-1100", "New York Session", group=kzGroup, inline="ny")
color nyColor = input.color(color.new(#FF8C00, 85), "", group=kzGroup, inline="ny")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ SMC SETTINGS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string smcGroup = "â•â•â• SMC OVERLAY â•â•â•"
bool showOB = input.bool(true, "Show Order Blocks", group=smcGroup)
bool showFVG = input.bool(true, "Show Fair Value Gaps", group=smcGroup)
bool showSwings = input.bool(true, "Show Swing H/L", group=smcGroup)
int pivotLen = input.int(5, "Pivot Length", minval=2, maxval=20, group=smcGroup)
int maxOBCount = input.int(2, "Max Order Blocks", minval=1, maxval=10, group=smcGroup)
int maxFVGCount = input.int(3, "Max FVGs", minval=1, maxval=10, group=smcGroup)
bool deleteFVGOnMitigation = input.bool(true, "Remove Filled FVGs", group=smcGroup)
color bullOBColor = input.color(color.new(#26A69A, 85), "Bull OB", group=smcGroup, inline="obcol")
color bearOBColor = input.color(color.new(#EF5350, 85), "Bear OB", group=smcGroup, inline="obcol")
color bullFVGColor = input.color(color.new(#00E676, 80), "Bull FVG", group=smcGroup, inline="fvgcol")
color bearFVGColor = input.color(color.new(#FF5252, 80), "Bear FVG", group=smcGroup, inline="fvgcol")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ RISK MANAGEMENT â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string riskGroup = "â•â•â• RISK MANAGEMENT â•â•â•"
bool showATRLevels = input.bool(true, "Show ATR SL/TP", group=riskGroup)
int atrLength = input.int(14, "ATR Length", minval=5, maxval=50, group=riskGroup)
float atrMultSL = input.float(2.0, "ATR x SL", minval=0.5, maxval=5.0, step=0.5, group=riskGroup)
color slColor = input.color(color.new(#FF5252, 50), "SL Line", group=riskGroup)
color tpColor = input.color(color.new(#00E676, 50), "TP Line", group=riskGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VISUAL SETTINGS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string visGroup = "â•â•â• VISUAL SETTINGS â•â•â•"
bool showSignals = input.bool(true, "Show Signal Arrows", group=visGroup)
bool showDashboard = input.bool(true, "Show Dashboard", group=visGroup)
bool showConfluenceScore = input.bool(true, "Show Confluence Score", group=visGroup)
color signalBuyColor = input.color(#00FF7F, "Buy Signal", group=visGroup, inline="sig")
color signalSellColor = input.color(#FF4757, "Sell Signal", group=visGroup, inline="sig")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ INTER-MARKET PANEL â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string imGroup = "â•â•â• ğŸŒ INTER-MARKET â•â•â•"
bool showInterMarket = input.bool(true, "Show Inter-Market Data", group=imGroup)
float gsrHighThresh = input.float(85.0, "Gold/Silver High (Risk-Off)", minval=70, maxval=100, group=imGroup)
float gsrLowThresh = input.float(70.0, "Gold/Silver Low (Risk-On)", minval=50, maxval=80, group=imGroup)
float jpyWarnThresh = input.float(155.0, "USD/JPY Carry Warning", minval=140, maxval=170, group=imGroup)
string silverSymbol = input.symbol("OANDA:XAGUSD", "Silver Symbol", group=imGroup)
string jpySymbol = input.symbol("OANDA:USDJPY", "USD/JPY Symbol", group=imGroup)
string dxySymbol = input.symbol("TVC:DXY", "DXY Symbol", group=imGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VOLUME SENTINEL (v9.1 - NOW REQUIRED!) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string volGroup = "â•â•â• ğŸ» VOLUME SENTINEL â•â•â•"
bool requireVolumeSentinel = input.bool(true, "ğŸ”’ REQUIRE Volume Confirmation", group=volGroup, tooltip="v9.1: Volume confirmation is now REQUIRED for all signals. Backtested +33% win rate improvement!")
int volLookback = input.int(20, "Volume Lookback", minval=10, maxval=50, group=volGroup)
float zThreshold = input.float(2.0, "Z-Score Surge Threshold", minval=1.0, maxval=3.0, step=0.1, group=volGroup, tooltip="Volume > 2.0Ïƒ = institutional surge")
float absorbThreshold = input.float(1.5, "Absorption Z-Score Min", minval=1.0, maxval=2.5, step=0.1, group=volGroup)
bool showSentinel = input.bool(true, "Show Sentinel Visuals", group=volGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ TIMEZONE & SESSION FUNCTIONS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tz = "America/New_York"

isInSession(string sess) =>
    not na(time(timeframe.period, sess, tz))

bool inLondon = isInSession("0300-0600")
bool inNY = isInSession("0800-1100")
bool inPowerHour = isInSession("0930-1030")
bool inSilverBullet = isInSession("1000-1100")

isValidSession() =>
    switch gameMode
        "SCALPER" => inLondon or inNY
        "DAY TRADER" => isInSession("0200-1200")
        "SWING" => true
        => true

bool validSession = isValidSession()

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ KILLZONE VISUALIZATION â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var float londonHigh = na
var float londonLow = na
var int londonStartBar = na
var bool londonActive = false
var box londonBox = na

if showKillzones
    if inLondon and not inLondon[1]
        londonActive := true
        londonStartBar := bar_index
        londonHigh := high
        londonLow := low
        box.delete(londonBox)
    
    if londonActive and inLondon
        londonHigh := math.max(londonHigh, high)
        londonLow := math.min(londonLow, low)
        box.delete(londonBox)
        londonBox := box.new(londonStartBar, londonHigh, bar_index, londonLow, border_color=color.new(londonColor, 20), border_width=1, bgcolor=londonColor, text="LONDON", text_color=color.white, text_size=size.tiny, text_halign=text.align_left, text_valign=text.align_top)
    
    if not inLondon and inLondon[1]
        londonActive := false

var float nyHigh = na
var float nyLow = na
var int nyStartBar = na
var bool nyActive = false
var box nyBox = na

if showKillzones
    if inNY and not inNY[1]
        nyActive := true
        nyStartBar := bar_index
        nyHigh := high
        nyLow := low
        box.delete(nyBox)
    
    if nyActive and inNY
        nyHigh := math.max(nyHigh, high)
        nyLow := math.min(nyLow, low)
        box.delete(nyBox)
        nyBox := box.new(nyStartBar, nyHigh, bar_index, nyLow, border_color=color.new(nyColor, 20), border_width=1, bgcolor=nyColor, text="NY", text_color=color.white, text_size=size.tiny, text_halign=text.align_left, text_valign=text.align_top)
    
    if not inNY and inNY[1]
        nyActive := false

bgcolor(showKillzones and inPowerHour ? color.new(#1E90FF, 90) : na, title="Power Hour")
bgcolor(showKillzones and inSilverBullet ? color.new(#00FFFF, 92) : na, title="Silver Bullet")

bool inSilverBulletPrep = isInSession("0955-1000")
bgcolor(showKillzones and inSilverBulletPrep ? color.new(#FFD700, 90) : na, title="SB Prep")

if showKillzones and inPowerHour and not inPowerHour[1]
    label.new(bar_index, high, "âš¡ POWER HOUR", style=label.style_label_down, color=color.new(#1E90FF, 50), textcolor=color.white, size=size.tiny)

if showKillzones and inSilverBulletPrep and not inSilverBulletPrep[1]
    label.new(bar_index, high, "â° SB IN 5 MIN", style=label.style_label_down, color=color.new(#FFD700, 0), textcolor=color.black, size=size.normal)

if showKillzones and inSilverBullet and not inSilverBullet[1]
    label.new(bar_index, high, "ğŸ¯ SILVER BULLET", style=label.style_label_down, color=color.new(#00FFFF, 50), textcolor=color.white, size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ CORE CALCULATIONS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float ema8 = ta.ema(close, 8)
float ema21 = ta.ema(close, 21)
float ema50 = ta.ema(close, 50)
float ema200 = ta.ema(close, 200)
float ema5 = ta.ema(close, 5)

int bbLength = 20
float bbMult = 1.0
float bbBasis = ta.sma(close, bbLength)
float bbDev = bbMult * ta.stdev(close, bbLength)
float bbUpper = bbBasis + bbDev
float bbLower = bbBasis - bbDev

float atrValue = ta.atr(atrLength)

[diPlus, diMinus, adxValue] = ta.dmi(adxPeriod, adxPeriod)

bool bullTrend = ema8 > ema21
bool bearTrend = ema8 < ema21
bool aboveSMA50 = close > ema50
bool belowSMA50 = close < ema50
bool aboveSMA200 = close > ema200
bool belowSMA200 = close < ema200

bool bullishBias = aboveSMA50 and aboveSMA200
bool bearishBias = belowSMA50 and belowSMA200

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ADX ENGINE (INSTITUTIONAL GATE) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool adxGateOpen = adxValue >= adxThreshold
bool adxTrending = adxValue >= 25
bool adxStrong = adxValue >= 30
bool adxExtreme = adxValue >= 35

float adxChange = adxValue - adxValue[5]
bool adxCollapsing = adxChange < -10

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ INTER-MARKET DATA â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float silverPrice = request.security(silverSymbol, timeframe.period, close)
float jpyPrice = request.security(jpySymbol, timeframe.period, close)
float dxyPrice = request.security(dxySymbol, timeframe.period, close)

float gsr = silverPrice != 0 ? close / silverPrice : na
float gsrMA = ta.sma(gsr, 20)

bool gsrRiskOff = gsr > gsrHighThresh
bool gsrRiskOn = gsr < gsrLowThresh
bool jpyCarryRisk = jpyPrice >= jpyWarnThresh
float jpyChange = jpyPrice - jpyPrice[5]
bool carryFragile = jpyCarryRisk and jpyChange < -1.0

float dxyMA = ta.sma(dxyPrice, 20)
bool dxyBullish = dxyPrice > dxyMA

bool riskOff = gsrRiskOff and dxyBullish
bool riskOn = gsrRiskOn and not dxyBullish

int imGoldBias = 0
imGoldBias += gsr < gsrMA ? 1 : gsr > gsrMA ? -1 : 0
imGoldBias += dxyPrice < dxyMA ? 1 : dxyPrice > dxyMA ? -1 : 0
imGoldBias += jpyChange < 0 ? 1 : jpyChange > 0 ? -1 : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VOLUME SENTINEL (BEAST MODE) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float avgVol = ta.sma(volume, volLookback)
float stdVol = ta.stdev(volume, volLookback)
float volZScore = stdVol != 0 ? (volume - avgVol) / stdVol : 0

float bodySize = math.abs(close - open)
float avgBody = ta.sma(bodySize, volLookback)
float candleRange = high - low
bool isHighVol = volZScore >= absorbThreshold
bool isSmallBody = candleRange > 0 ? bodySize < candleRange * 0.3 : false
bool isAbsorption = isHighVol and isSmallBody

bool volSurge = volZScore >= zThreshold
bool volumeConfirmed = volSurge or isAbsorption

plotshape(showSentinel and isAbsorption ? low : na, "Absorption", shape.diamond, location.belowbar, color.new(#9C27B0, 30), size=size.tiny)
bgcolor(showSentinel and volSurge ? color.new(#9C27B0, 92) : na, title="Z-Score Surge")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ FAIR VALUE GAPS (FVG) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var box[] bullFVGs = array.new_box()
var box[] bearFVGs = array.new_box()

if showFVG and bar_index > 2
    float minGapSize = atrValue * 0.1
    
    bool bullFVGDetected = low > high[2]
    float bullGapSize = low - high[2]
    if bullFVGDetected and bullGapSize >= minGapSize
        fvgTop = low
        fvgBottom = high[2]
        fvgBox = box.new(bar_index - 1, fvgTop, bar_index + 20, fvgBottom, border_color=bullFVGColor, border_style=line.style_dotted, bgcolor=bullFVGColor, text="FVG", text_color=color.new(#00E676, 20), text_size=size.tiny, text_halign=text.align_right, text_valign=text.align_center)
        array.push(bullFVGs, fvgBox)
        if array.size(bullFVGs) > maxFVGCount
            box.delete(array.shift(bullFVGs))
    
    bool bearFVGDetected = high < low[2]
    float bearGapSize = low[2] - high
    if bearFVGDetected and bearGapSize >= minGapSize
        fvgTop = low[2]
        fvgBottom = high
        fvgBox = box.new(bar_index - 1, fvgTop, bar_index + 20, fvgBottom, border_color=bearFVGColor, border_style=line.style_dotted, bgcolor=bearFVGColor, text="FVG", text_color=color.new(#FF5252, 20), text_size=size.tiny, text_halign=text.align_right, text_valign=text.align_center)
        array.push(bearFVGs, fvgBox)
        if array.size(bearFVGs) > maxFVGCount
            box.delete(array.shift(bearFVGs))

if deleteFVGOnMitigation
    if array.size(bullFVGs) > 0
        for i = array.size(bullFVGs) - 1 to 0
            if i < array.size(bullFVGs)
                fvgBox = array.get(bullFVGs, i)
                fvgBottom = box.get_bottom(fvgBox)
                if close < fvgBottom
                    box.delete(fvgBox)
                    array.remove(bullFVGs, i)
    
    if array.size(bearFVGs) > 0
        for i = array.size(bearFVGs) - 1 to 0
            if i < array.size(bearFVGs)
                fvgBox = array.get(bearFVGs, i)
                fvgTop = box.get_top(fvgBox)
                if close > fvgTop
                    box.delete(fvgBox)
                    array.remove(bearFVGs, i)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ SWING DETECTION & ORDER BLOCKS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float pivotHighVal = ta.pivothigh(high, pivotLen, pivotLen)
float pivotLowVal = ta.pivotlow(low, pivotLen, pivotLen)
bool newSwingHigh = not na(pivotHighVal)
bool newSwingLow = not na(pivotLowVal)

if showSwings and newSwingHigh
    label.new(bar_index - pivotLen, high[pivotLen], "SH", style=label.style_label_down, color=color.new(bearOBColor, 50), textcolor=color.white, size=size.tiny)

if showSwings and newSwingLow
    label.new(bar_index - pivotLen, low[pivotLen], "SL", style=label.style_label_up, color=color.new(bullOBColor, 50), textcolor=color.white, size=size.tiny)

var box[] bullOBBoxes = array.new_box()
var box[] bearOBBoxes = array.new_box()
float minOBSize = atrValue * 0.3

if showOB and newSwingLow
    for i = pivotLen to pivotLen + 10
        if close[i] < open[i]
            float obHigh = high[i]
            float obLow = low[i]
            float obSize = obHigh - obLow
            if obSize >= minOBSize
                obBox = box.new(bar_index - i, obHigh, bar_index + 20, obLow, border_color=bullOBColor, border_style=line.style_dotted, bgcolor=color.new(bullOBColor, 92), text="OB", text_color=color.new(#26A69A, 30), text_size=size.tiny, text_halign=text.align_right, text_valign=text.align_top)
                array.push(bullOBBoxes, obBox)
                if array.size(bullOBBoxes) > maxOBCount
                    box.delete(array.shift(bullOBBoxes))
            break

if showOB and newSwingHigh
    for i = pivotLen to pivotLen + 10
        if close[i] > open[i]
            float obHigh = high[i]
            float obLow = low[i]
            float obSize = obHigh - obLow
            if obSize >= minOBSize
                obBox = box.new(bar_index - i, obHigh, bar_index + 20, obLow, border_color=bearOBColor, border_style=line.style_dotted, bgcolor=color.new(bearOBColor, 92), text="OB", text_color=color.new(#EF5350, 30), text_size=size.tiny, text_halign=text.align_right, text_valign=text.align_bottom)
                array.push(bearOBBoxes, obBox)
                if array.size(bearOBBoxes) > maxOBCount
                    box.delete(array.shift(bearOBBoxes))
            break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ CONFLUENCE SCORE ENGINE (1-10) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
calcConfluenceScore(bool isBuy) =>
    float score = 0.0
    
    if adxGateOpen
        score += 1.5
    if adxStrong
        score += 1.0
    if adxExtreme
        score += 0.5
    
    if isBuy and bullishBias
        score += 2.0
    else if not isBuy and bearishBias
        score += 2.0
    else if isBuy and aboveSMA200
        score += 1.0
    else if not isBuy and belowSMA200
        score += 1.0
    
    if isBuy and bullTrend
        score += 1.5
    else if not isBuy and bearTrend
        score += 1.5
    
    if inPowerHour or inSilverBullet
        score += 1.5
    else if inLondon or inNY
        score += 1.0
    
    if isBuy and low <= bbLower
        score += 1.0
    else if not isBuy and high >= bbUpper
        score += 1.0
    
    if volSurge
        score += 3.0
    else if isAbsorption
        score += 2.0
    else if volZScore >= 1.0
        score += 1.0
    
    math.min(score, 10.0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ SIGNAL LOGIC (v9.1 - VOLUME REQUIRED!) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool touchedLowerBB = low <= bbLower
bool touchedUpperBB = high >= bbUpper
bool bullCandle = close > open
bool bearCandle = close < open

bool inBullOB = false
if array.size(bullOBBoxes) > 0
    for i = 0 to array.size(bullOBBoxes) - 1
        if i < array.size(bullOBBoxes)
            obBox = array.get(bullOBBoxes, i)
            obTop = box.get_top(obBox)
            obBottom = box.get_bottom(obBox)
            if low <= obTop and low >= obBottom
                inBullOB := true
                break
            if close <= obTop and close >= obBottom
                inBullOB := true
                break

bool inBearOB = false
if array.size(bearOBBoxes) > 0
    for i = 0 to array.size(bearOBBoxes) - 1
        if i < array.size(bearOBBoxes)
            obBox = array.get(bearOBBoxes, i)
            obTop = box.get_top(obBox)
            obBottom = box.get_bottom(obBox)
            if high >= obBottom and high <= obTop
                inBearOB := true
                break
            if close >= obBottom and close <= obTop
                inBearOB := true
                break

bool buyZone = inBullOB or touchedLowerBB
bool sellZone = inBearOB or touchedUpperBB

bool inKillzone = inLondon or inNY

bool classicBuy = bullCandle and buyZone and bullTrend and validSession
bool classicSell = bearCandle and sellZone and bearTrend and validSession

bool instBuyFilter = adxGateOpen and aboveSMA200 and bullTrend and inKillzone
bool instSellFilter = adxGateOpen and belowSMA200 and bearTrend and inKillzone and inBearOB

bool instBuy = classicBuy and instBuyFilter
bool instSell = classicSell and instSellFilter

bool rawBuySignal = institutionalMode ? instBuy : classicBuy
bool rawSellSignal = institutionalMode ? instSell : classicSell

var int lastBuyBar = na
var int lastSellBar = na
int signalCooldown = 5

bool buyCooldownOk = na(lastBuyBar) or (bar_index - lastBuyBar >= signalCooldown)
bool sellCooldownOk = na(lastSellBar) or (bar_index - lastSellBar >= signalCooldown)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¥ v9.1 CHANGE: Volume Sentinel is now REQUIRED for signals!
// Backtested: +33% win rate improvement with volume confirmation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool volumeGate = requireVolumeSentinel ? volumeConfirmed : true

bool buySignal = rawBuySignal and barstate.isconfirmed and buyCooldownOk and volumeGate
bool sellSignal = rawSellSignal and barstate.isconfirmed and sellCooldownOk and volumeGate

if buySignal
    lastBuyBar := bar_index
if sellSignal
    lastSellBar := bar_index

float buyConfluence = buySignal ? calcConfluenceScore(true) : 0
float sellConfluence = sellSignal ? calcConfluenceScore(false) : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ 3x ATR TRAILING LEVELS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var float trailLong1 = na
var float trailLong2 = na
var float trailLong3 = na
var float trailShort1 = na
var float trailShort2 = na
var float trailShort3 = na
var int trailBarIndex = na

if buySignal
    trailBarIndex := bar_index
    trailLong1 := close + atrValue * 1.0
    trailLong2 := close + atrValue * 2.0
    trailLong3 := close + atrValue * atrTrailMult

if sellSignal
    trailBarIndex := bar_index
    trailShort1 := close - atrValue * 1.0
    trailShort2 := close - atrValue * 2.0
    trailShort3 := close - atrValue * atrTrailMult

if not na(trailBarIndex) and bar_index > trailBarIndex + 50
    trailLong1 := na
    trailLong2 := na
    trailLong3 := na
    trailShort1 := na
    trailShort2 := na
    trailShort3 := na

plot(trailLong1, "Long 1R", color.new(#4CAF50, 60), 1, plot.style_linebr)
plot(trailLong2, "Long 2R", color.new(#8BC34A, 50), 1, plot.style_linebr)
plot(trailLong3, "Long 3R", color.new(#CDDC39, 40), 2, plot.style_linebr)
plot(trailShort1, "Short 1R", color.new(#F44336, 60), 1, plot.style_linebr)
plot(trailShort2, "Short 2R", color.new(#E91E63, 50), 1, plot.style_linebr)
plot(trailShort3, "Short 3R", color.new(#9C27B0, 40), 2, plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ EMA PLOTTING â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
p1 = plot(ema8, "EMA 8", color.new(#00E676, 0), 2)
p2 = plot(ema21, "EMA 21", color.new(#FFA726, 0), 2)
plot(ema50, "EMA 50", color.new(#42A5F5, 50), 1)
plot(ema200, "EMA 200", color.new(#AB47BC, 0), 2)

ribbonColor = bullTrend ? color.new(#00E676, 70) : color.new(#FF5252, 70)
fill(p1, p2, ribbonColor, title="EMA Ribbon")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ SIGNAL ARROWS (APEX BEAST TIER) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool kzAllowed = killzoneSignalsOnly ? (inLondon or inNY) : true

bool apexBuySignal = buySignal and buyConfluence >= 8 and volumeConfirmed
bool apexSellSignal = sellSignal and sellConfluence >= 8 and volumeConfirmed

bool standardBuy = buySignal and not apexBuySignal
bool standardSell = sellSignal and not apexSellSignal

plotshape(showSignals and apexBuySignal and kzAllowed ? low : na, "ğŸ”¥ APEX BUY", shape.triangleup, location.belowbar, color.new(#00FF00, 0), size=size.large)
plotshape(showSignals and apexSellSignal and kzAllowed ? high : na, "ğŸ”¥ APEX SELL", shape.triangledown, location.abovebar, color.new(#FF0000, 0), size=size.large)

plotshape(showSignals and standardBuy and kzAllowed ? low : na, "Buy Signal", shape.triangleup, location.belowbar, signalBuyColor, size=size.normal)
plotshape(showSignals and standardSell and kzAllowed ? high : na, "Sell Signal", shape.triangledown, location.abovebar, signalSellColor, size=size.normal)

if showSignals and apexBuySignal and kzAllowed
    string confText = showConfluenceScore ? "\nâš¡ " + str.tostring(buyConfluence, "#.#") + "/10" : ""
    label.new(bar_index, low, "ğŸ”¥ BEAST\n" + str.tostring(close, format.mintick) + confText, style=label.style_label_up, color=color.new(#00FF00, 0), textcolor=color.white, size=size.normal)
else if showSignals and standardBuy and kzAllowed
    string confText = showConfluenceScore ? "\nâš¡ " + str.tostring(buyConfluence, "#.#") + "/10" : ""
    label.new(bar_index, low, "BUY\n" + str.tostring(close, format.mintick) + confText, style=label.style_label_up, color=signalBuyColor, textcolor=color.white, size=size.small)

if showSignals and apexSellSignal and kzAllowed
    string confText = showConfluenceScore ? "\nâš¡ " + str.tostring(sellConfluence, "#.#") + "/10" : ""
    label.new(bar_index, high, "ğŸ”¥ BEAST\n" + str.tostring(close, format.mintick) + confText, style=label.style_label_down, color=color.new(#FF0000, 0), textcolor=color.white, size=size.normal)
else if showSignals and standardSell and kzAllowed
    string confText = showConfluenceScore ? "\nâš¡ " + str.tostring(sellConfluence, "#.#") + "/10" : ""
    label.new(bar_index, high, "SELL\n" + str.tostring(close, format.mintick) + confText, style=label.style_label_down, color=signalSellColor, textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ INSTITUTIONAL DASHBOARD â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if showDashboard
    var table dashboard = table.new(position.bottom_right, 2, 16, bgcolor=color.new(#000000, 30), border_width=1, border_color=color.new(#00FF00, 50))
    
    table.cell(dashboard, 0, 0, "ğŸ¦", text_color=color.new(#00FF00, 0), text_size=size.normal, text_halign=text.align_center)
    table.cell(dashboard, 1, 0, "RBFX v9.1 INSTITUTIONAL", text_color=color.new(#00FF00, 0), text_size=size.small, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 1, "MODE", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string modeText = institutionalMode ? "ğŸ”’ INSTITUTIONAL" : "âš¡ CLASSIC"
    color modeColor = institutionalMode ? color.new(#00FFFF, 0) : color.lime
    table.cell(dashboard, 1, 1, modeText, text_color=modeColor, text_size=size.tiny, text_halign=text.align_left)
    
    // v9.1: Volume Gate Status
    table.cell(dashboard, 0, 2, "VOL GATE", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string volGateText = requireVolumeSentinel ? (volumeConfirmed ? "ğŸŸ¢ OPEN" : "ğŸ”´ CLOSED") : "âšª OFF"
    color volGateColor = requireVolumeSentinel ? (volumeConfirmed ? color.lime : color.red) : color.gray
    table.cell(dashboard, 1, 2, volGateText, text_color=volGateColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 3, "ADX ENGINE", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string adxText = str.tostring(adxValue, "#.#")
    color adxColor = adxGateOpen ? (adxExtreme ? color.new(#00FF00, 0) : color.new(#7CFC00, 0)) : color.new(#FF4444, 0)
    string adxStatus = adxGateOpen ? " âœ…" : " ğŸ”´ GATE CLOSED"
    table.cell(dashboard, 1, 3, adxText + adxStatus, text_color=adxColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 4, "SMA BIAS", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string biasText = bullishBias ? "ğŸ“ˆ BULLISH" : bearishBias ? "ğŸ“‰ BEARISH" : "âšª NEUTRAL"
    color biasColor = bullishBias ? color.lime : bearishBias ? color.red : color.gray
    table.cell(dashboard, 1, 4, biasText, text_color=biasColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 5, "REGIME", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string regimeText = adxExtreme ? "ğŸ”¥ EXTREME TREND" : adxStrong ? "ğŸ“ˆ STRONG TREND" : adxTrending ? "â†—ï¸ TRENDING" : "â†”ï¸ RANGING"
    color regimeColor = adxExtreme ? color.new(#FFD700, 0) : adxStrong ? color.new(#00FF00, 0) : adxTrending ? color.new(#7CFC00, 0) : color.new(#FF6347, 0)
    table.cell(dashboard, 1, 5, regimeText, text_color=regimeColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 6, "SESSION", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string sessionText = inSilverBullet ? "ğŸ¯ SILVER BULLET" : inPowerHour ? "âš¡ POWER HOUR" : inLondon ? "LONDON" : inNY ? "NEW YORK" : "OFF HOURS"
    color sessionColor = inSilverBullet ? color.aqua : inPowerHour ? color.new(#1E90FF, 0) : inLondon ? color.teal : inNY ? color.orange : color.gray
    table.cell(dashboard, 1, 6, sessionText, text_color=sessionColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 7, "SIGNAL", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string signalText = buySignal ? "ğŸŸ¢ BUY ACTIVE" : sellSignal ? "ğŸ”´ SELL ACTIVE" : "SCANNING..."
    color signalColor = buySignal ? signalBuyColor : sellSignal ? signalSellColor : color.gray
    table.cell(dashboard, 1, 7, signalText, text_color=signalColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 8, "CONFLUENCE", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    float activeConf = buySignal ? buyConfluence : sellSignal ? sellConfluence : 0
    string confText = activeConf > 0 ? str.tostring(activeConf, "#.#") + "/10" : "---"
    color confColor = activeConf >= 8 ? color.new(#00FF00, 0) : activeConf >= 6 ? color.new(#FFD700, 0) : activeConf > 0 ? color.new(#FF6347, 0) : color.gray
    string apexTag = (apexBuySignal or apexSellSignal) ? " ğŸ”¥ APEX" : ""
    table.cell(dashboard, 1, 8, confText + apexTag, text_color=confColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 9, "SENTINEL", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string volText = volSurge ? "ğŸ» Z>" + str.tostring(zThreshold, "#.#") + "Ïƒ" : isAbsorption ? "ğŸ›¡ï¸ ABSORB" : "Z: " + str.tostring(volZScore, "#.#") + "Ïƒ"
    color volColor = volSurge ? color.new(#9C27B0, 0) : isAbsorption ? color.new(#9C27B0, 30) : volZScore >= 1.0 ? color.new(#7CFC00, 0) : color.gray
    table.cell(dashboard, 1, 9, volText, text_color=volColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 10, "ATR", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    table.cell(dashboard, 1, 10, str.tostring(atrValue, format.mintick), text_color=color.white, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 11, "ALERT", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    string alertText = adxCollapsing ? "âš ï¸ ADX COLLAPSE" : "âœ… CLEAR"
    color alertColor = adxCollapsing ? color.new(#FF0000, 0) : color.new(#00FF00, 50)
    table.cell(dashboard, 1, 11, alertText, text_color=alertColor, text_size=size.tiny, text_halign=text.align_left)
    
    table.cell(dashboard, 0, 12, "TARGETS", text_color=color.gray, text_size=size.tiny, text_halign=text.align_right)
    table.cell(dashboard, 1, 12, "1R â†’ 2R â†’ 3R+", text_color=color.new(#FFD700, 0), text_size=size.tiny, text_halign=text.align_left)
    
    if showInterMarket
        table.cell(dashboard, 0, 13, "AU/AG", text_color=color.new(#00FFFF, 50), text_size=size.tiny, text_halign=text.align_right)
        string gsrText = str.tostring(gsr, "#.#")
        string gsrStatus = gsrRiskOff ? " ğŸ”´" : gsrRiskOn ? " ğŸŸ¢" : ""
        color gsrColor = gsrRiskOff ? color.new(#FF5252, 0) : gsrRiskOn ? color.new(#00E676, 0) : color.white
        table.cell(dashboard, 1, 13, gsrText + gsrStatus, text_color=gsrColor, text_size=size.tiny, text_halign=text.align_left)
        
        table.cell(dashboard, 0, 14, "USD/JPY", text_color=color.new(#00FFFF, 50), text_size=size.tiny, text_halign=text.align_right)
        string jpyText = str.tostring(jpyPrice, "#.##")
        string jpyStatus = carryFragile ? " âš ï¸" : jpyCarryRisk ? " â¬†ï¸" : ""
        color jpyColor = carryFragile ? color.new(#FF0000, 0) : jpyCarryRisk ? color.new(#FFD700, 0) : color.white
        table.cell(dashboard, 1, 14, jpyText + jpyStatus, text_color=jpyColor, text_size=size.tiny, text_halign=text.align_left)
        
        table.cell(dashboard, 0, 15, "ğŸŒ REGIME", text_color=color.new(#00FFFF, 50), text_size=size.tiny, text_halign=text.align_right)
        string imRegimeText = carryFragile ? "âš ï¸ CARRY RISK" : riskOff ? "ğŸ”´ RISK-OFF" : riskOn ? "ğŸŸ¢ RISK-ON" : "âšª NEUTRAL"
        color imRegimeColor = carryFragile ? color.new(#FF0000, 0) : riskOff ? color.new(#FF5252, 0) : riskOn ? color.new(#00E676, 0) : color.gray
        table.cell(dashboard, 1, 15, imRegimeText, text_color=imRegimeColor, text_size=size.tiny, text_halign=text.align_left)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ALERTS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(apexBuySignal or apexSellSignal, title="ğŸ”¥ APEX BEAST SIGNAL", message="ğŸ”¥ BEAST SENTINEL: Volume-Confirmed APEX Setup (Score â‰¥8) on {{ticker}} @ {{close}}")
alertcondition(buySignal, title="Institutional Buy", message="ğŸ¦ RBFX v9.1 BUY @ {{close}} | {{ticker}} | VOL CONFIRMED âœ…")
alertcondition(sellSignal, title="Institutional Sell", message="ğŸ¦ RBFX v9.1 SELL @ {{close}} | {{ticker}} | VOL CONFIRMED âœ…")
alertcondition(adxGateOpen and not adxGateOpen[1], title="ADX Gate Open", message="âœ… ADX Gate OPEN on {{ticker}}")
alertcondition(not adxGateOpen and adxGateOpen[1], title="ADX Gate Closed", message="ğŸ”´ ADX Gate CLOSED on {{ticker}}")
alertcondition(adxCollapsing, title="ADX Collapse Warning", message="âš ï¸ DISASTER ALERT: ADX dropped >10 points on {{ticker}}")
alertcondition(volSurge, title="Volume Surge", message="ğŸ» Volume Z-Score Surge detected on {{ticker}}")
alertcondition(volumeConfirmed and not volumeConfirmed[1], title="Volume Gate Open", message="ğŸŸ¢ VOLUME GATE OPEN on {{ticker}} - Signals enabled!")
alertcondition(carryFragile and not carryFragile[1], title="Carry Unwind Warning", message="âš ï¸ INTER-MARKET: USD/JPY Carry Fragility Alert")
alertcondition(riskOn and not riskOn[1], title="Risk-On Regime", message="ğŸŸ¢ INTER-MARKET: Risk-On (Silver outperforming)")
alertcondition(riskOff and not riskOff[1], title="Risk-Off Regime", message="ğŸ”´ INTER-MARKET: Risk-Off (Gold dominance)")
alertcondition(inSilverBulletPrep and not inSilverBulletPrep[1], title="â° Silver Bullet PREP", message="â° SILVER BULLET in 5 minutes! Get ready on {{ticker}}")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ END OF SCRIPT - v9.1 â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•