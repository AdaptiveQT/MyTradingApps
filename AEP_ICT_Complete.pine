// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© AEP Protocol [ICT COMPLETE] - FVG + Order Blocks + Killzones + Silver Bullet

//@version=5
indicator("AEP x ICT [COMPLETE]", overlay=true, max_boxes_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ MASTER TOGGLES â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpMaster = "Master Toggles"
bool showFVG = input.bool(true, "Show Fair Value Gaps", group=grpMaster)
bool showOB = input.bool(true, "Show Order Blocks", group=grpMaster)
bool showKillzones = input.bool(true, "Show Killzones", group=grpMaster)
bool showBOS = input.bool(true, "Show Break of Structure", group=grpMaster)
bool showSignals = input.bool(true, "Show Silver Bullet Signals", group=grpMaster)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ KILLZONE SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpKZ = "Killzones"
bool showLondonKZ = input.bool(true, "London (2-5 AM)", group=grpKZ)
bool showNYKZ = input.bool(true, "NY AM (8:30-11 AM)", group=grpKZ)
bool showSilverBullet = input.bool(true, "Silver Bullet (10-11 AM)", group=grpKZ)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ FVG SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpFVG = "Fair Value Gaps"
int maxFVG = input.int(30, "Max FVG Boxes", minval=5, group=grpFVG)
color bullFVGCol = input.color(color.new(color.teal, 75), "Bullish FVG", group=grpFVG)
color bearFVGCol = input.color(color.new(color.maroon, 75), "Bearish FVG", group=grpFVG)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ORDER BLOCK SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpOB = "Order Blocks"
int obLookback = input.int(5, "Structure Lookback", minval=3, group=grpOB)
int maxOB = input.int(15, "Max Order Blocks", minval=5, group=grpOB)
bool showMeanThreshold = input.bool(true, "Show 50% Mean Threshold", group=grpOB)
bool autoInvalidate = input.bool(true, "Auto-Delete Invalid OBs", group=grpOB)
color bullOBCol = input.color(color.new(color.green, 60), "Bullish OB", group=grpOB)
color bearOBCol = input.color(color.new(color.red, 60), "Bearish OB", group=grpOB)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ DISPLACEMENT SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpDisp = "Displacement"
float dispMult = input.float(1.5, "Body Multiplier", minval=1.0, step=0.1, group=grpDisp)
int dispLookback = input.int(10, "Lookback Period", minval=5, group=grpDisp)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ KILLZONE DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool inLondonKZ = not na(time(timeframe.period, "0200-0500", "America/New_York"))
bool inNYKZ = not na(time(timeframe.period, "0830-1100", "America/New_York"))
bool inSilverBullet = not na(time(timeframe.period, "1000-1100", "America/New_York"))

// Background colors
bgcolor(showKillzones and showLondonKZ and inLondonKZ and not inNYKZ ? color.new(color.blue, 93) : na, title="London")
bgcolor(showKillzones and showNYKZ and inNYKZ and not inSilverBullet ? color.new(color.purple, 93) : na, title="NY AM")
bgcolor(showKillzones and showSilverBullet and inSilverBullet ? color.new(color.yellow, 88) : na, title="Silver Bullet")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ FVG DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool isBullFVG = low > high[2]
bool isBearFVG = high < low[2]

var box[] bullFVGBoxes = array.new_box()
var box[] bearFVGBoxes = array.new_box()

if showFVG and isBullFVG
    box newBox = box.new(bar_index[2], low, bar_index + 30, high[2], border_color=na, bgcolor=bullFVGCol)
    array.push(bullFVGBoxes, newBox)
    if array.size(bullFVGBoxes) > maxFVG
        box.delete(array.shift(bullFVGBoxes))

if showFVG and isBearFVG
    box newBox = box.new(bar_index[2], low[2], bar_index + 30, high, border_color=na, bgcolor=bearFVGCol)
    array.push(bearFVGBoxes, newBox)
    if array.size(bearFVGBoxes) > maxFVG
        box.delete(array.shift(bearFVGBoxes))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ORDER BLOCK DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Swing detection
float ph = ta.pivothigh(high, obLookback, obLookback)
float pl = ta.pivotlow(low, obLookback, obLookback)

var float lastSwingHigh = na
var float lastSwingLow = na

if not na(ph)
    lastSwingHigh := ph
if not na(pl)
    lastSwingLow := pl

// Pre-calculate for consistency
bool crossAboveHigh = ta.crossover(close, lastSwingHigh)
bool crossBelowLow = ta.crossunder(close, lastSwingLow)

// Break of Structure
bool bosUp = not na(lastSwingHigh) and crossAboveHigh
bool bosDn = not na(lastSwingLow) and crossBelowLow

plotshape(showBOS and bosUp, style=shape.triangleup, location=location.belowbar, color=color.lime, text="BOS", textcolor=color.lime, size=size.tiny)
plotshape(showBOS and bosDn, style=shape.triangledown, location=location.abovebar, color=color.red, text="BOS", textcolor=color.red, size=size.tiny)

// OB Box arrays
var box[] bullOBBoxes = array.new_box()
var box[] bearOBBoxes = array.new_box()
var line[] bullOBLines = array.new_line()
var line[] bearOBLines = array.new_line()

// Bullish OB Creation
if showOB and bosUp
    int obIdx = na
    float lowestLow = high * 100000
    for i = 1 to 20
        if close[i] < open[i] and low[i] < lowestLow
            lowestLow := low[i]
            obIdx := i
    if not na(obIdx)
        float t = high[obIdx]
        float b = low[obIdx]
        box newBox = box.new(bar_index - obIdx, t, bar_index + 50, b, border_color=color.new(color.green, 30), bgcolor=bullOBCol, border_width=1)
        array.push(bullOBBoxes, newBox)
        if showMeanThreshold
            line newLine = line.new(bar_index - obIdx, (t + b) / 2, bar_index + 50, (t + b) / 2, color=color.new(color.white, 40), style=line.style_dotted)
            array.push(bullOBLines, newLine)
        if array.size(bullOBBoxes) > maxOB
            box.delete(array.shift(bullOBBoxes))
            if array.size(bullOBLines) > 0
                line.delete(array.shift(bullOBLines))

// Bearish OB Creation
if showOB and bosDn
    int obIdx = na
    float highestHigh = 0.0
    for i = 1 to 20
        if close[i] > open[i] and high[i] > highestHigh
            highestHigh := high[i]
            obIdx := i
    if not na(obIdx)
        float t = high[obIdx]
        float b = low[obIdx]
        box newBox = box.new(bar_index - obIdx, t, bar_index + 50, b, border_color=color.new(color.red, 30), bgcolor=bearOBCol, border_width=1)
        array.push(bearOBBoxes, newBox)
        if showMeanThreshold
            line newLine = line.new(bar_index - obIdx, (t + b) / 2, bar_index + 50, (t + b) / 2, color=color.new(color.white, 40), style=line.style_dotted)
            array.push(bearOBLines, newLine)
        if array.size(bearOBBoxes) > maxOB
            box.delete(array.shift(bearOBBoxes))
            if array.size(bearOBLines) > 0
                line.delete(array.shift(bearOBLines))

// Auto-invalidation
if autoInvalidate
    if array.size(bullOBBoxes) > 0
        for i = array.size(bullOBBoxes) - 1 to 0
            box b = array.get(bullOBBoxes, i)
            if close < box.get_bottom(b)
                box.delete(b)
                array.remove(bullOBBoxes, i)
                if i < array.size(bullOBLines)
                    line.delete(array.get(bullOBLines, i))
                    array.remove(bullOBLines, i)
    if array.size(bearOBBoxes) > 0
        for i = array.size(bearOBBoxes) - 1 to 0
            box b = array.get(bearOBBoxes, i)
            if close > box.get_top(b)
                box.delete(b)
                array.remove(bearOBBoxes, i)
                if i < array.size(bearOBLines)
                    line.delete(array.get(bearOBLines, i))
                    array.remove(bearOBLines, i)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SILVER BULLET SIGNALS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float bodySize = math.abs(close - open)
float avgBody = ta.sma(bodySize, dispLookback)
bool displacement = bodySize > avgBody * dispMult
bool bullDisp = displacement and close > open
bool bearDisp = displacement and close < open

// Signal: FVG + Displacement during Silver Bullet
bool sbLong = showSignals and inSilverBullet and isBullFVG and bullDisp
bool sbShort = showSignals and inSilverBullet and isBearFVG and bearDisp

plotshape(sbLong, style=shape.labelup, location=location.belowbar, color=color.green, text="SB\nLONG", textcolor=color.white, size=size.small)
plotshape(sbShort, style=shape.labeldown, location=location.abovebar, color=color.red, text="SB\nSHORT", textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ OB TOUCH DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool bullOBTouch = false
bool bearOBTouch = false

for i = 0 to math.min(array.size(bullOBBoxes) - 1, 5)
    if array.size(bullOBBoxes) > i
        box bx = array.get(bullOBBoxes, i)
        if low <= box.get_top(bx) and low >= box.get_bottom(bx)
            bullOBTouch := true

for i = 0 to math.min(array.size(bearOBBoxes) - 1, 5)
    if array.size(bearOBBoxes) > i
        box bx = array.get(bearOBBoxes, i)
        if high >= box.get_bottom(bx) and high <= box.get_top(bx)
            bearOBTouch := true

plotshape(bullOBTouch and not sbLong, style=shape.circle, location=location.belowbar, color=color.lime, size=size.tiny, title="Bull OB Touch")
plotshape(bearOBTouch and not sbShort, style=shape.circle, location=location.abovebar, color=color.red, size=size.tiny, title="Bear OB Touch")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ DASHBOARD â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var table dash = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 70), border_width=1, border_color=color.gray)
if barstate.islast
    table.cell(dash, 0, 0, "AEP x ICT", text_color=color.white, text_size=size.small, bgcolor=color.new(color.orange, 40))
    table.merge_cells(dash, 0, 0, 1, 0)
    
    // Session
    string kz = inSilverBullet ? "ğŸ¯ SILVER BULLET" : inNYKZ ? "ğŸ“ NY KILLZONE" : inLondonKZ ? "ğŸŒ LONDON" : "â¸ï¸ OFF-HOURS"
    color kzCol = inSilverBullet ? color.yellow : inNYKZ ? color.purple : inLondonKZ ? color.blue : color.gray
    table.cell(dash, 0, 1, "Session", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 1, kz, text_color=kzCol, text_size=size.tiny)
    
    // FVGs
    table.cell(dash, 0, 2, "Bull FVG", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 2, str.tostring(array.size(bullFVGBoxes)), text_color=color.teal, text_size=size.tiny)
    table.cell(dash, 0, 3, "Bear FVG", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 3, str.tostring(array.size(bearFVGBoxes)), text_color=color.maroon, text_size=size.tiny)
    
    // OBs
    table.cell(dash, 0, 4, "Bull OB", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 4, str.tostring(array.size(bullOBBoxes)), text_color=color.green, text_size=size.tiny)
    table.cell(dash, 0, 5, "Bear OB", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 5, str.tostring(array.size(bearOBBoxes)), text_color=color.red, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ALERTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(sbLong, title="Silver Bullet LONG", message="ğŸ¯ ICT Silver Bullet LONG on {{ticker}}")
alertcondition(sbShort, title="Silver Bullet SHORT", message="ğŸ¯ ICT Silver Bullet SHORT on {{ticker}}")
alertcondition(bullOBTouch, title="Bullish OB Touch", message="Price touched Bullish Order Block on {{ticker}}")
alertcondition(bearOBTouch, title="Bearish OB Touch", message="Price touched Bearish Order Block on {{ticker}}")
alertcondition(bosUp, title="Bullish BOS", message="Break of Structure UP on {{ticker}}")
alertcondition(bosDn, title="Bearish BOS", message="Break of Structure DOWN on {{ticker}}")
