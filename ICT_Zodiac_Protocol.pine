// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0
// Â© ICT x Zodiac Protocol [ULTIMATE] - TFO Killzones + Pivots + FVG + OB + Astro

//@version=5
indicator("ICT x Zodiac [ULTIMATE]", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ MASTER TOGGLES â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpMaster = "Master Toggles"
bool showKillzones = input.bool(true, "Show Killzones", group=grpMaster)
bool showPivots = input.bool(true, "Show Pivots", group=grpMaster)
bool showPDLevels = input.bool(true, "Show PDH/PDL/PWH/PWL", group=grpMaster)
bool showFVG = input.bool(true, "Show FVGs", group=grpMaster)
bool showOB = input.bool(true, "Show Order Blocks", group=grpMaster)
bool showBOS = input.bool(true, "Show Break of Structure", group=grpMaster)
bool showZodiac = input.bool(true, "Show Zodiac Dashboard", group=grpMaster)
bool presentMode = input.bool(true, "Present Mode (Fresh Zones Only)", group=grpMaster, tooltip="When ON, removes FVGs/OBs when price fills them")
bool zodiacFilter = input.bool(true, "Zodiac Signal Filter", group=grpMaster, tooltip="Only show signals when zodiac aligns with direction")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ KILLZONE SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpKZ = "Killzones"
bool showAsiaKZ = input.bool(true, "Show Asia", group=grpKZ)
string asiaTime = input.string("2000-0000", "Asia Time", group=grpKZ, tooltip="Format: HHMM-HHMM (NY time)")
bool showLondonKZ = input.bool(true, "Show London", group=grpKZ)
string londonTime = input.string("0200-0500", "London Time", group=grpKZ)
bool showNYKZ = input.bool(true, "Show NY AM", group=grpKZ)
string nyTime = input.string("0700-1000", "NY AM Time", group=grpKZ)
bool showKZOpen = input.bool(true, "Show KZ Open Lines", group=grpKZ)

color asiaCol = input.color(color.new(color.yellow, 88), "Asia Color", group=grpKZ)
color londonCol = input.color(color.new(color.blue, 88), "London Color", group=grpKZ)
color nyCol = input.color(color.new(color.green, 88), "NY Color", group=grpKZ)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ PIVOT SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpPivot = "Pivots"
bool showDailyPivots = input.bool(true, "Daily Pivots", group=grpPivot)
bool showWeeklyPivots = input.bool(false, "Weekly Pivots", group=grpPivot)
string pivotType = input.string("Traditional", "Type", options=["Traditional", "Fibonacci", "Camarilla"], group=grpPivot)
color pivotCol = input.color(color.orange, "Pivot (P)", group=grpPivot)
color rCol = input.color(color.red, "R Levels", group=grpPivot)
color sCol = input.color(color.green, "S Levels", group=grpPivot)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ICT STRUCTURE SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpICT = "ICT Structure"
int structLen = input.int(5, "Structure Lookback", minval=3, group=grpICT)
int maxFVG = input.int(3, "Max FVGs", minval=1, maxval=20, group=grpICT)
int maxOB = input.int(3, "Max Order Blocks", minval=1, maxval=10, group=grpICT)
color bullFvgCol = input.color(color.new(#089981, 85), "Bull FVG", group=grpICT)
color bearFvgCol = input.color(color.new(#f23645, 85), "Bear FVG", group=grpICT)
color bullObCol = input.color(color.new(#00bcd4, 80), "Bull OB", group=grpICT)
color bearObCol = input.color(color.new(#ff5252, 80), "Bear OB", group=grpICT)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ZODIAC SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grpAstro = "Zodiac"
int moonOffset = input.int(10, "Moon Degree Offset", group=grpAstro)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 1. ZODIAC CALCULATION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
lunarAge() =>
    int y = year
    int m = month
    int d = dayofmonth
    if m <= 2
        y := y - 1
        m := m + 12
    int A = math.floor(y / 100)
    int B = 2 - A + math.floor(A / 4)
    float JD = math.floor(365.25 * (y + 4716)) + math.floor(30.6001 * (m + 1)) + d + B - 1524.5
    float age = (JD - 2451550.1 + moonOffset) % 29.53058867
    if age < 0
        age := age + 29.53058867
    age

float moonAge = lunarAge()
string[] zodiacSigns = array.from("Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces")
int zodiacIdx = math.floor((moonAge / 29.53) * 12) % 12
string currentZodiac = array.get(zodiacSigns, zodiacIdx)

string moonPhase = moonAge < 1.85 ? "ğŸŒ‘ New" : moonAge < 7.38 ? "ğŸŒ’ Wax Cres" : moonAge < 11.07 ? "ğŸŒ“ 1st Qtr" : moonAge < 14.76 ? "ğŸŒ” Wax Gib" : moonAge < 16.61 ? "ğŸŒ• Full" : moonAge < 22.14 ? "ğŸŒ– Wan Gib" : moonAge < 25.83 ? "ğŸŒ— 3rd Qtr" : "ğŸŒ˜ Wan Cres"

string element = "Neutral"
string ictBias = "Balanced"
string ictFocus = "Standard"
color elemCol = color.gray

string[] fireSigns = array.from("Aries", "Leo", "Sagittarius")
string[] earthSigns = array.from("Taurus", "Virgo", "Capricorn")
string[] airSigns = array.from("Gemini", "Libra", "Aquarius")
string[] waterSigns = array.from("Cancer", "Scorpio", "Pisces")

if array.includes(fireSigns, currentZodiac)
    element := "ğŸ”¥ FIRE"
    ictBias := "EXPANSION"
    ictFocus := "Trust BOS & FVGs"
    elemCol := color.orange
else if array.includes(waterSigns, currentZodiac)
    element := "ğŸ’§ WATER"
    ictBias := "MANIPULATION"
    ictFocus := "Fade Liq Grabs"
    elemCol := color.aqua
else if array.includes(airSigns, currentZodiac)
    element := "ğŸŒªï¸ AIR"
    ictBias := "CONSOLIDATION"
    ictFocus := "Scalp IRL"
    elemCol := color.silver
else if array.includes(earthSigns, currentZodiac)
    element := "ğŸŒ EARTH"
    ictBias := "STRUCTURE"
    ictFocus := "Deep OTE"
    elemCol := color.green

// Zodiac Bias for filtering
bool bullishBias = array.includes(fireSigns, currentZodiac) or array.includes(earthSigns, currentZodiac)
bool bearishBias = array.includes(waterSigns, currentZodiac) or array.includes(airSigns, currentZodiac)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 2. KILLZONE DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool inAsia = not na(time(timeframe.period, asiaTime, "America/New_York"))
bool inLondon = not na(time(timeframe.period, londonTime, "America/New_York"))
bool inNY = not na(time(timeframe.period, nyTime, "America/New_York"))

bool asiaStart = inAsia and not inAsia[1]
bool londonStart = inLondon and not inLondon[1]
bool nyStart = inNY and not inNY[1]

bool asiaEnd = not inAsia and inAsia[1]
bool londonEnd = not inLondon and inLondon[1]
bool nyEnd = not inNY and inNY[1]

// Session tracking
var float asiaOpen = na, var float londonOpen = na, var float nyOpen = na
var float asiaHigh = na, var float asiaLow = na
var float londonHigh = na, var float londonLow = na
var float nyHigh = na, var float nyLow = na
var int asiaStartBar = na, var int londonStartBar = na, var int nyStartBar = na

// Asia
if asiaStart
    asiaOpen := open, asiaHigh := high, asiaLow := low, asiaStartBar := bar_index
if inAsia
    asiaHigh := math.max(asiaHigh, high), asiaLow := math.min(asiaLow, low)

// London  
if londonStart
    londonOpen := open, londonHigh := high, londonLow := low, londonStartBar := bar_index
if inLondon
    londonHigh := math.max(londonHigh, high), londonLow := math.min(londonLow, low)

// NY
if nyStart
    nyOpen := open, nyHigh := high, nyLow := low, nyStartBar := bar_index
if inNY
    nyHigh := math.max(nyHigh, high), nyLow := math.min(nyLow, low)

// â•â•â• KILLZONE BOXES â•â•â•
var box asiaBox = na, var box londonBox = na, var box nyBox = na
var line asiaHighLine = na, var line asiaLowLine = na
var line londonHighLine = na, var line londonLowLine = na
var line nyHighLine = na, var line nyLowLine = na
var label asiaLabel = na, var label londonLabel = na, var label nyLabel = na

// Update boxes dynamically during session
if showKillzones and showAsiaKZ and inAsia
    box.delete(asiaBox)
    line.delete(asiaHighLine), line.delete(asiaLowLine)
    label.delete(asiaLabel)
    asiaBox := box.new(asiaStartBar, asiaHigh, bar_index, asiaLow, border_color=color.new(color.yellow, 50), bgcolor=asiaCol, border_width=1)
    asiaHighLine := line.new(asiaStartBar, asiaHigh, bar_index + 20, asiaHigh, color=color.new(color.yellow, 30), style=line.style_dashed, width=1)
    asiaLowLine := line.new(asiaStartBar, asiaLow, bar_index + 20, asiaLow, color=color.new(color.yellow, 30), style=line.style_dashed, width=1)
    asiaLabel := label.new(asiaStartBar, asiaHigh, "ASIA", style=label.style_none, textcolor=color.yellow, size=size.small)

if showKillzones and showLondonKZ and inLondon
    box.delete(londonBox)
    line.delete(londonHighLine), line.delete(londonLowLine)
    label.delete(londonLabel)
    londonBox := box.new(londonStartBar, londonHigh, bar_index, londonLow, border_color=color.new(color.blue, 50), bgcolor=londonCol, border_width=1)
    londonHighLine := line.new(londonStartBar, londonHigh, bar_index + 20, londonHigh, color=color.new(color.blue, 30), style=line.style_dashed, width=1)
    londonLowLine := line.new(londonStartBar, londonLow, bar_index + 20, londonLow, color=color.new(color.blue, 30), style=line.style_dashed, width=1)
    londonLabel := label.new(londonStartBar, londonHigh, "LONDON", style=label.style_none, textcolor=color.blue, size=size.small)

if showKillzones and showNYKZ and inNY
    box.delete(nyBox)
    line.delete(nyHighLine), line.delete(nyLowLine)
    label.delete(nyLabel)
    nyBox := box.new(nyStartBar, nyHigh, bar_index, nyLow, border_color=color.new(color.green, 50), bgcolor=nyCol, border_width=1)
    nyHighLine := line.new(nyStartBar, nyHigh, bar_index + 20, nyHigh, color=color.new(color.green, 30), style=line.style_dashed, width=1)
    nyLowLine := line.new(nyStartBar, nyLow, bar_index + 20, nyLow, color=color.new(color.green, 30), style=line.style_dashed, width=1)
    nyLabel := label.new(nyStartBar, nyHigh, "NY AM", style=label.style_none, textcolor=color.green, size=size.small)

// KZ Open lines (dotted through session)
plot(showKZOpen and showAsiaKZ and inAsia ? asiaOpen : na, "Asia Open", color.new(color.yellow, 40), style=plot.style_linebr)
plot(showKZOpen and showLondonKZ and inLondon ? londonOpen : na, "LDN Open", color.new(color.blue, 40), style=plot.style_linebr)
plot(showKZOpen and showNYKZ and inNY ? nyOpen : na, "NY Open", color.new(color.green, 40), style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 3. PIVOTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[dHigh, dLow, dClose] = request.security(syminfo.tickerid, "D", [high[1], low[1], close[1]], lookahead=barmerge.lookahead_on)

calcPivots(h, l, c, pType) =>
    float p = (h + l + c) / 3
    float r1 = 0.0, float r2 = 0.0, float s1 = 0.0, float s2 = 0.0
    if pType == "Traditional"
        r1 := (2 * p) - l, s1 := (2 * p) - h
        r2 := p + (h - l), s2 := p - (h - l)
    else if pType == "Fibonacci"
        r1 := p + 0.382 * (h - l), s1 := p - 0.382 * (h - l)
        r2 := p + 0.618 * (h - l), s2 := p - 0.618 * (h - l)
    else if pType == "Camarilla"
        r1 := c + (h - l) * 1.1 / 12, s1 := c - (h - l) * 1.1 / 12
        r2 := c + (h - l) * 1.1 / 6, s2 := c - (h - l) * 1.1 / 6
    [p, r1, r2, s1, s2]

[dP, dR1, dR2, dS1, dS2] = calcPivots(dHigh, dLow, dClose, pivotType)

plot(showPivots and showDailyPivots ? dP : na, "Pivot", pivotCol, style=plot.style_circles, linewidth=2)
plot(showPivots and showDailyPivots ? dR1 : na, "R1", rCol, style=plot.style_cross)
plot(showPivots and showDailyPivots ? dR2 : na, "R2", color.new(rCol, 40), style=plot.style_cross)
plot(showPivots and showDailyPivots ? dS1 : na, "S1", sCol, style=plot.style_cross)
plot(showPivots and showDailyPivots ? dS2 : na, "S2", color.new(sCol, 40), style=plot.style_cross)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 4. PDH/PDL/PWH/PWL â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float pdh = request.security(syminfo.tickerid, "D", high[1], lookahead=barmerge.lookahead_on)
float pdl = request.security(syminfo.tickerid, "D", low[1], lookahead=barmerge.lookahead_on)
float pwh = request.security(syminfo.tickerid, "W", high[1], lookahead=barmerge.lookahead_on)
float pwl = request.security(syminfo.tickerid, "W", low[1], lookahead=barmerge.lookahead_on)

plot(showPDLevels ? pdh : na, "PDH", color.new(color.red, 20), style=plot.style_linebr, linewidth=2)
plot(showPDLevels ? pdl : na, "PDL", color.new(color.green, 20), style=plot.style_linebr, linewidth=2)
plot(showPDLevels ? pwh : na, "PWH", color.new(color.fuchsia, 40), style=plot.style_linebr, linewidth=1)
plot(showPDLevels ? pwl : na, "PWL", color.new(color.aqua, 40), style=plot.style_linebr, linewidth=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 5. FVG DETECTION (WITH STRENGTH GRADING) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bool isBullFVG = low > high[2]
bool isBearFVG = high < low[2]

// Strength Detection
float avgRange = ta.sma(high - low, 14)
float fvgGapBull = isBullFVG ? (low - high[2]) : 0
float fvgGapBear = isBearFVG ? (low[2] - high) : 0
float dispBody = math.abs(close[1] - open[1])
float avgBody = ta.sma(math.abs(close - open), 14)

// Strong = Large gap + Displacement candle + During killzone
bool inKillzone = inLondon or inNY or inSB
bool hasDisplacement = dispBody > avgBody * 1.5
bool strongBullFVG = isBullFVG and fvgGapBull > avgRange * 0.3 and hasDisplacement
bool strongBearFVG = isBearFVG and fvgGapBear > avgRange * 0.3 and hasDisplacement

var box[] bullFVGs = array.new_box()
var box[] bearFVGs = array.new_box()
var float[] bullFVGTops = array.new_float()
var float[] bullFVGBots = array.new_float()
var float[] bearFVGTops = array.new_float()
var float[] bearFVGBots = array.new_float()

// Create Bull FVG (Strong vs Weak)
if showFVG and isBullFVG
    float fvgTop = low
    float fvgBot = high[2]
    string fvgLabel = strongBullFVG ? "â–® FVG â˜…" : "â–® FVG"
    int bWidth = strongBullFVG ? 2 : 1
    color bCol = strongBullFVG ? color.new(#089981, 75) : bullFvgCol
    box b = box.new(bar_index[2], fvgTop, bar_index + 50, fvgBot, border_color=color.new(#089981, 30), bgcolor=bCol, border_width=bWidth, text=fvgLabel, text_color=#089981, text_size=size.small, text_halign=text.align_right, text_valign=text.align_center)
    array.push(bullFVGs, b)
    array.push(bullFVGTops, fvgTop)
    array.push(bullFVGBots, fvgBot)
    if array.size(bullFVGs) > maxFVG
        box.delete(array.shift(bullFVGs))
        array.shift(bullFVGTops)
        array.shift(bullFVGBots)

// Create Bear FVG (Strong vs Weak)
if showFVG and isBearFVG
    float fvgTop = low[2]
    float fvgBot = high
    string fvgLabel = strongBearFVG ? "â–® FVG â˜…" : "â–® FVG"
    int bWidth = strongBearFVG ? 2 : 1
    color bCol = strongBearFVG ? color.new(#f23645, 75) : bearFvgCol
    box b = box.new(bar_index[2], fvgTop, bar_index + 50, fvgBot, border_color=color.new(#f23645, 30), bgcolor=bCol, border_width=bWidth, text=fvgLabel, text_color=#f23645, text_size=size.small, text_halign=text.align_right, text_valign=text.align_center)
    array.push(bearFVGs, b)
    array.push(bearFVGTops, fvgTop)
    array.push(bearFVGBots, fvgBot)
    if array.size(bearFVGs) > maxFVG
        box.delete(array.shift(bearFVGs))
        array.shift(bearFVGTops)
        array.shift(bearFVGBots)

// â•â•â• FVG MITIGATION (Present Mode) â•â•â•
if presentMode and array.size(bullFVGs) > 0
    for i = array.size(bullFVGs) - 1 to 0
        if i < array.size(bullFVGBots)
            float bot = array.get(bullFVGBots, i)
            // Bull FVG mitigated when price closes below its bottom
            if close < bot
                box.delete(array.get(bullFVGs, i))
                array.remove(bullFVGs, i)
                array.remove(bullFVGTops, i)
                array.remove(bullFVGBots, i)

if presentMode and array.size(bearFVGs) > 0
    for i = array.size(bearFVGs) - 1 to 0
        if i < array.size(bearFVGTops)
            float top = array.get(bearFVGTops, i)
            // Bear FVG mitigated when price closes above its top
            if close > top
                box.delete(array.get(bearFVGs, i))
                array.remove(bearFVGs, i)
                array.remove(bearFVGTops, i)
                array.remove(bearFVGBots, i)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 6. ORDER BLOCKS (WITH MITIGATION) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float sh = ta.pivothigh(high, structLen, structLen)
float sl = ta.pivotlow(low, structLen, structLen)
var float lastSH = na, var float lastSL = na
if not na(sh)
    lastSH := sh
if not na(sl)
    lastSL := sl

bool crossHigh = ta.crossover(close, lastSH)
bool crossLow = ta.crossunder(close, lastSL)
bool bosUp = not na(lastSH) and crossHigh
bool bosDn = not na(lastSL) and crossLow

if showBOS and bosUp
    label.new(bar_index, high, "BOSâ†‘", color=color.new(color.green, 100), style=label.style_label_down, textcolor=color.lime, size=size.tiny)
if showBOS and bosDn
    label.new(bar_index, low, "BOSâ†“", color=color.new(color.red, 100), style=label.style_label_up, textcolor=color.red, size=size.tiny)

var box[] bullOBs = array.new_box()
var box[] bearOBs = array.new_box()
var float[] bullOBBots = array.new_float()
var float[] bearOBTops = array.new_float()

// Create Bull OB (Strong vs Weak)
if showOB and bosUp
    int idx = na
    for i = 1 to 10
        if close[i] < open[i]
            idx := i
            break
    if not na(idx)
        float obTop = high[idx]
        float obBot = low[idx]
        float obBody = math.abs(close[idx] - open[idx])
        bool strongOB = obBody > avgBody * 1.3 and inKillzone
        string obLabel = strongOB ? "â–® OB â˜…" : "â–® OB"
        int obWidth = strongOB ? 3 : 1
        color obBgCol = strongOB ? color.new(#00bcd4, 70) : bullObCol
        box b = box.new(bar_index - idx, obTop, bar_index + 60, obBot, border_color=color.new(#00bcd4, 20), bgcolor=obBgCol, border_width=obWidth, text=obLabel, text_color=#00bcd4, text_size=size.small, text_halign=text.align_right, text_valign=text.align_center)
        array.push(bullOBs, b)
        array.push(bullOBBots, obBot)
        if array.size(bullOBs) > maxOB
            box.delete(array.shift(bullOBs))
            array.shift(bullOBBots)

// Create Bear OB (Strong vs Weak)
if showOB and bosDn
    int idx = na
    for i = 1 to 10
        if close[i] > open[i]
            idx := i
            break
    if not na(idx)
        float obTop = high[idx]
        float obBot = low[idx]
        float obBody = math.abs(close[idx] - open[idx])
        bool strongOB = obBody > avgBody * 1.3 and inKillzone
        string obLabel = strongOB ? "â–® OB â˜…" : "â–® OB"
        int obWidth = strongOB ? 3 : 1
        color obBgCol = strongOB ? color.new(#ff5252, 70) : bearObCol
        box b = box.new(bar_index - idx, obTop, bar_index + 60, obBot, border_color=color.new(#ff5252, 20), bgcolor=obBgCol, border_width=obWidth, text=obLabel, text_color=#ff5252, text_size=size.small, text_halign=text.align_right, text_valign=text.align_center)
        array.push(bearOBs, b)
        array.push(bearOBTops, obTop)
        if array.size(bearOBs) > maxOB
            box.delete(array.shift(bearOBs))
            array.shift(bearOBTops)

// â•â•â• ORDER BLOCK MITIGATION (Present Mode) â•â•â•
if presentMode and array.size(bullOBs) > 0
    for i = array.size(bullOBs) - 1 to 0
        if i < array.size(bullOBBots)
            float bot = array.get(bullOBBots, i)
            // Bull OB invalidated when price closes below
            if close < bot
                box.delete(array.get(bullOBs, i))
                array.remove(bullOBs, i)
                array.remove(bullOBBots, i)

if presentMode and array.size(bearOBs) > 0
    for i = array.size(bearOBs) - 1 to 0
        if i < array.size(bearOBTops)
            float top = array.get(bearOBTops, i)
            // Bear OB invalidated when price closes above
            if close > top
                box.delete(array.get(bearOBs, i))
                array.remove(bearOBs, i)
                array.remove(bearOBTops, i)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 7. SILVER BULLET SIGNALS (ZODIAC FILTERED) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float bodySize = math.abs(close - open)
bool disp = bodySize > avgBody * 1.5

// Base SB signals
bool sbLongBase = inSB and isBullFVG and disp and close > open
bool sbShortBase = inSB and isBearFVG and disp and close < open

// Apply zodiac filter if enabled
bool sbLong = zodiacFilter ? (sbLongBase and bullishBias) : sbLongBase
bool sbShort = zodiacFilter ? (sbShortBase and bearishBias) : sbShortBase

// Strong signals (strong FVG + displacement + killzone aligned)
bool sbLongStrong = sbLong and strongBullFVG
bool sbShortStrong = sbShort and strongBearFVG

// Visual differentiation: Strong = â˜…, Weak = standard
plotshape(sbLongStrong, style=shape.labelup, location=location.belowbar, color=color.green, text="SB â˜…", textcolor=color.white, size=size.normal)
plotshape(sbLong and not sbLongStrong, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 40), text="SB", textcolor=color.white, size=size.small)
plotshape(sbShortStrong, style=shape.labeldown, location=location.abovebar, color=color.red, text="SB â˜…", textcolor=color.white, size=size.normal)
plotshape(sbShort and not sbShortStrong, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 40), text="SB", textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ 8. DASHBOARD â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var table dash = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 60), border_width=1, border_color=color.gray)

if showZodiac and barstate.islast
    table.cell(dash, 0, 0, "ICT x ZODIAC", text_color=color.white, text_size=size.small, bgcolor=elemCol)
    table.merge_cells(dash, 0, 0, 1, 0)
    
    string sess = inSB ? "ğŸ¯ SILVER BULLET" : inNY ? "ğŸŸ¢ NY AM" : inLondon ? "ğŸ”µ LONDON" : inAsia ? "ğŸŸ¡ ASIA" : "â¸ï¸ OFF"
    color sessCol = inSB ? color.orange : inNY ? color.green : inLondon ? color.blue : inAsia ? color.yellow : color.gray
    table.cell(dash, 0, 1, "Session", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 1, sess, text_color=sessCol, text_size=size.tiny)
    
    table.cell(dash, 0, 2, "Moon", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 2, moonPhase, text_color=color.white, text_size=size.tiny)
    
    table.cell(dash, 0, 3, "Sign", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 3, currentZodiac, text_color=elemCol, text_size=size.tiny)
    
    table.cell(dash, 0, 4, "Element", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 4, element, text_color=elemCol, text_size=size.tiny)
    
    table.cell(dash, 0, 5, "Profile", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 5, ictBias, text_color=color.yellow, text_size=size.tiny)
    
    table.cell(dash, 0, 6, "Focus", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 6, ictFocus, text_color=color.lime, text_size=size.tiny)
    
    table.cell(dash, 0, 7, "PDH", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 7, str.tostring(pdh, format.mintick), text_color=color.red, text_size=size.tiny)
    
    table.cell(dash, 0, 8, "PDL", text_color=color.white, text_size=size.tiny)
    table.cell(dash, 1, 8, str.tostring(pdl, format.mintick), text_color=color.green, text_size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ALERTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(sbLong, title="Silver Bullet LONG", message="ğŸ¯ Silver Bullet LONG")
alertcondition(sbShort, title="Silver Bullet SHORT", message="ğŸ¯ Silver Bullet SHORT")
alertcondition(bosUp, title="Bullish BOS", message="BOS UP")
alertcondition(bosDn, title="Bearish BOS", message="BOS DOWN")
alertcondition(londonStart, title="London Open", message="London Session Started")
alertcondition(nyStart, title="NY Open", message="NY AM Session Started")
